# LINE_UI_POLICY.md - LINE版チュートリアル運用ポリシー（v1.4 Draft）

本書は、セルフ脱毛サロン ハイジの「総合顧客サポートLINE（line.）」上で動作する

顧客向け AI チュートリアル UI（LINE_UI）の運用ポリシーを定義する。

HELP_UI（help.）と同様に、

- 「どの範囲を AI で受けるか」
- 「どこから人間にエスカレーションするか」
- 「チャネルごとの役割分担」
- 「トーン＆スタイル／NGライン」

を明確化することで、各フェーズの仕様と運用をブレさせないことを目的とする。

## 1. 位置づけとチャネル役割

### 1.1 総合顧客サポートLINE（line.）の役割

- LINE公式アカウントは **1つで全店舗対応** する。
- 顧客目線では「ハイジ全体の窓口」として振る舞いつつ、
実際には以下のように役割分担する：
    - **総合LINE（line.）**
        - お試し体験の案内・予約導線
        - 回数券／定額プラン／都度払いの予約導線（店舗タイプに応じて）
        - 予約内容の確認（日時・店舗・メニュー）
        - 解錠番号の提示（本人確認済み＋条件を満たす場合のみ）
        - 利用方法・入室方法・忘れ物案内などの共通サポート
        - 店舗選択／店舗変更、会員連携（名寄せ）
        - 店舗によっては、予約・購入を店舗LINEへ誘導
    - **Webチュートリアル（help.）**
        - メールベースの問い合わせ・チュートリアル
        - 長文での相談・利用前の情報収集向き
    - **店舗専用LINE（店舗ごと）**
        - 一部店舗では、予約・チケット購入を店舗LINEで完結させる運用も許容
        - 総合LINEからは「店舗専用LINE」への導線のみ提供する場合がある
    - **オーナーポータル（shop.）／本部ポータル（ai.）**
        - LINE問い合わせを含む全チャネルの `tickets`／`ai_sessions` を閲覧・返信するUI
        - どの案件にどう返信するか（LINE／電話／メール）はここで人間が判断

### 1.2 HELP_UI との違い

- HELP_UI は「Webフォーム＋メール」の世界であり、
    - 画面は help. の単一UI
    - 連絡手段は主にメール返信
- LINE_UI は「LINEトーク＋LIFF＋リッチメニュー」の世界であり、
    - リッチメニュー／タブ／LIFF によって入口が複数ある
    - 即時のチャット体験を前提とする

本ポリシーでは、HELP_UI_POLICY と共通する部分は踏襲しつつ、

- **タブ構造／SLOT_◯◯ の扱い**
- **名寄せ（LINE ID ↔ STORES）＋店舗選択のUX**
- **解錠番号の出し方**
- **総合LINE vs 店舗LINE の境界**

といった LINE 特有の点を追加で規定する。

---

## 2. トーン＆スタイル

### 2.1 基本トーン（HELP_UIと共通）

- 自動化＝冷たい・機械的にならないよう、
「人間のスタッフが丁寧に説明してくれている」ようなトーンを基本とする。
- 顧客向け（line./help.）では：
    - 絵文字や顔文字を適度に使用して親しみやすさを出してよい
    - ただし、深刻なトラブル（ケガ・火災・機器破損等）では絵文字を控え、真摯な文面を優先
- 加盟店向け・本部向け（shop./ai.）とはトーンを分けるが、LINE_UIでは基本的に顧客向けトーンのみ扱う。

### 2.2 ボット感NG

- 「私はAIです」「BOTです」といった表現を頻発させない。
- ただし、誤解を招きそうな場面（健康・法的・金銭トラブル）では、
    - 「自動応答でできる範囲を超えているので、人が詳しく確認します」
    と明示する。
- テンプレ感の強い短文を連発せず、
必要な場面では一言コメントを足す（例：「ご不安な中、すみません…」など）。

---

## 3. 受け付ける／受け付けないテーマ

HELP_UI と同様、AIが一次対応する範囲と、即人手に切り替えるテーマを明確にする。

### 3.1 AIで一次対応する代表例

- 料金・プラン内容の説明（回数券／定額／都度払いの違いなど）
- お試し体験の流れ・来店の持ち物・所要時間
- キャンペーン・クーポンの使い方（※発行条件の判定は後フェーズ）
- 利用方法（マシンの当て方／冷却の仕方／ジェルの使い方 等）
- 予約方法・予約導線の案内（URL or LIFFの誘導）
- 解約・退会の流れ（具体的な金額確定は人手に回す場合もあり）
- 忘れ物の基本ルール（保管期間や受け取り方法）

### 3.2 即エスカレーション（AIは整理だけ）

- 健康被害・ケガ・皮膚トラブルに関する申告
- 機械の故障・重大な設備トラブル（火災・漏電など）
- 返金・補償・賠償に関する具体的な金額交渉
- 法的な相談（訴訟・警察や行政への通報など）
- 強いクレーム・人格攻撃・ハラスメントに発展しそうなケース

AIは状況整理まで（いつ・どの店舗で・どんな症状か）を聞き、

できるだけ短いターンで `tickets` にチケット化して人に渡す。

---

## 4. 入口ポリシー（テキスト vs ボタン）

### 4.1 テキストからの問い合わせ

- ユーザーがテキストボックスに直接メッセージを書いた場合も、**必ず AI は反応する**。
- セッションが存在する場合：
    - そのまま「会話の続き」として扱う。
- セッションが存在しない（初回 or 一定時間経過後）の場合：
    - `line_user_shop_links`／`customer_links` を参照して、
        - `anonymous_no_store`（店舗未選択）
        - `anonymous_with_store`
        - `linked_with_store`
        などの状態に応じた「最初の一言」を返す。
    - 店舗未選択の場合は、いきなり店舗選択案内から入る。

### 4.2 リッチメニュー／SLOT_MESSAGE_CONTACT

- `SLOT_MESSAGE_CONTACT`（メッセージによるお問い合わせ）は、
    - 「AIチュートリアルをここから始める」ための**ショートカット**であり、
    - 押した瞬間に LIFF を開くものではない。
- ポリシー：
    - テキストでいきなり相談されても、ボタンからでも、**同じAIフロー**に乗る。
    - 入口がどちらかによって、回答内容や優先度を変えない。

---

## 5. 店舗選択／店舗変更ポリシー

### 5.1 初回の店舗選択

- `anonymous_no_store` 状態のユーザーが問い合わせしてきた場合、LINE_UIは：
    - 最初に「どの店舗についてのご相談か」を確認する。
    - 「ハイジ全体への質問」／「まだ利用した店舗はない」も選択肢として用意する。
- 選択結果は `line_user_shop_links` に `relation_type=primary` として保存する。

### 5.2 店舗前提の明示

- 店舗紐づき（Bレイヤ）がある場合、店舗固有の話をするときは必ず：
    - 「現在【◯◯店】をご利用中の前提でお話ししますね。」
    に相当する一言を冒頭に入れる。
- 「別の店舗の話をしたい」ユーザーのために：
    - HOMEタブ or SUPPORTタブに「利用店舗の変更（SLOT_STORE_SELECT）」を常設する。
    - 場合によってはクイックリプライでも店舗変更を促す。

### 5.3 複数店舗を渡り歩くケース

- `line_user_shop_links` は複数店舗を保持できるが、
    - 新しい店舗リンクは、
        - ユーザーが明示的に店舗を選択したとき
        - STORES予約実績が確認できたときに限り追加する。
    - AIの推測だけで勝手に他店舗リンクを増やさない。

---

## 6. 名寄せ（LINE ID ↔ STORES会員）のポリシー

### 6.1 名寄せのタイミング

- 名寄せは LIFF `mode=identity` を使って行う。
- ポリシー：
    - 一般的な問い合わせ（効果／料金／利用方法）では、名寄せを強制しない。
    - 以下のような intent の場合に名寄せ必須とする：
        - 予約内容確認
        - 解錠番号提示
        - 予約キャンセル／変更の具体的サポート
        - 会員向けキャンペーン／クーポン条件の判定
- 初回案内で「会員連携しておくと便利です」と軽く触れるのは許容とする（強制ではない）。

### 6.2 名寄せ成功後の自動再実行

- `line_ui.auto_retry_after_identity = true` をデフォルトとし、
    - 名寄せ成功後は、直前にユーザーが聞いていた内容を**自動で再実行**する。
    - ユーザーに同じ文章をもう一度入力させない。

---

## 7. 解錠番号ポリシー

### 7.1 解錠番号を出す条件

- 解錠番号（SLOT_UNLOCK_CODE）は以下をすべて満たすときにのみ表示する：
    1. 名寄せ済み（`identity_status="linked"`）
    2. 予約が1件に特定できている（通常は「直近の未来予約」1件）
    3. 対象予約が、現ポリシー上「解錠番号提示を許可するメニュー」であること
- 店舗ごとの「キー発行パターン」（電話番号の下◯桁＋日付など）は
API_COMM／別モジュールで管理し、LINE_UI側にはパターンロジックを埋め込まない。

### 7.2 予約確認と解錠番号の分離

- `SLOT_RESERVATION_STATUS`（予約確認）では**絶対に解錠番号を表示しない**。
    - 日時・店舗名・メニューのみ表示し、
    「この予約で合っていますか？」を確認する役割とする。
- 解錠番号は `SLOT_UNLOCK_CODE` だけが出せる。

### 7.3 誤操作・安全確保

- 解錠番号表示の前に、Flexカードで予約日時を強調し、
    - 「この予約日時で間違いなければ、解錠番号を表示します。」
    といった確認文（DEFAULT_TEXTS）を必ず挟む。
- 回数制限・時間制限（例：1時間に◯回まで）は `LINE_UI_DEFAULT_PARAMS` 側で設定する。

---

## 8. 総合LINE vs 店舗専用LINE の境界

### 8.1 店舗LINEへ丸投げする店舗

- `shop_options.booking_redirect_to_store_line = 1` の店舗では：
    - 予約・チケット購入は総合LINEでは受けない。
    - HOMEタブには `SLOT_STORE_LINE_JUMP` を配置し、
        - 「この店舗の予約・購入は店舗専用LINEをご利用ください」という文言を表示。
- 解錠番号・予約確認・忘れ物案内など、「全店共通の運用で対応できるもの」は
総合LINE側で受けるかどうかを別途ポリシーで定義する。

### 8.2 ポリシーの優先順位

- 「店舗LINEで受ける／総合LINEで受ける」のルールは、
    - まず `shop_options` のフラグによって決定
    - その上で、本ポリシー（LINE_UI_POLICY）の文章を運用マニュアルとする
- コード側は `shop_options`／`shop_links` の値だけを見て挙動を決め、
店舗IDベタ書きによる例外実装は禁止。

---
