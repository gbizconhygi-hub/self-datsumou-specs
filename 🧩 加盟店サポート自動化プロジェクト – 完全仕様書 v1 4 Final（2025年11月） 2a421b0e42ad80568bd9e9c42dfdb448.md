# 🧩 加盟店サポート自動化プロジェクト – 完全仕様書 v1.4 Final（2025年11月）

---

## 1. プロジェクト概要

### 目的

加盟店・本部・顧客すべての連絡をAIが一次対応し、

**自動チケット化／通知／分析／請求／報告まで統合管理**する。

ChatWork・メール・LINE・電話・予約など分散していた窓口を、

**AI-INBOX（本部）と加盟店ポータル（shop.）に統一。**

---

## 2. ドメイン構成

| サブドメイン | 役割 | 補足 |
| --- | --- | --- |
| **help.self-datsumou.net** | 顧客AIチュートリアル（Web） | STORES・HPから来た顧客。AIチャット。メールで返信。 |
| **line.self-datsumou.net** | LINEチュートリアル | LINEトークでAI応答／返信。 |
| **shop.self-datsumou.net** | 加盟店ポータル | 顧客対応・申請・請求・AI相談・MTG予約。 |
| **ai.self-datsumou.net** | 本部AI-INBOX | 全tickets統合／承認／請求／AI設定管理。 |
| **assets.self-datsumou.net** | CDN | PDF・画像等。 |
| **self-datsumou.net（root）** | メール送信ドメイン | SPF／DKIM／DMARC認証済み。 |

---

## 3. チャネル別顧客対応構造

| チャネル | 顧客体験 | 回答経路 | チケットsource | 特徴 |
| --- | --- | --- | --- | --- |
| **Web (help.)** | ブラウザAIチャット | メール返信 | `'stores_form'` or `'hp_form'` | STORES・HPから。 |
| **LINE (line.)** | LINEトーク | LINEメッセージ返信 | `'customer_line'` | LINE Messaging API連携。 |
| **共通AIコア (shared/ai_core.php)** | 意図分類＋自然文生成 | — | — | どちらからも呼出し。 |

---

## 4. AIコア仕様（AI-INBOXの中枢）

### 機能概要

- 顧客・加盟店・本部すべてのチャネルで使用。
- **分類・回答・自然言語生成・FAQ学習**を一元管理。

### 管理UI（本部）

- ai. 内に **AIコア設定管理UI** を標準搭載。
- 機能：
    - 意図分類パラメータCSVインポート／エクスポート
    - 質問パターン／回答テンプレート登録フォーム
    - AIモデル調整（temperature／top_p）
    - スコアしきい値設定（confidence閾値）
    - 辞書ベースルール管理（キーワード・除外語・緊急語）

### パラメータDB

- `ai_core_params`: モデル／閾値／temperature／top_p
- `ai_core_templates`: intentごとの回答テンプレ
- `ai_core_patterns`: 質問言い回し例

### ロジック

1. **分類**：FAQ候補抽出 → OpenAI推論でカテゴリ化＋スコア
2. **回答生成**：FAQテンプレ＋チャネル別トーン＋生成文（人間味）
3. **学習チューニング**：feedback結果でテンプレ修正・重み調整
4. **本部UIで即反映**（AI-INBOX側から再学習不要）

---

## 5. STORES予約API連携（顧客特定・本人認証）

### 目的

AIチュートリアル（Web／LINE）で**本人確認と顧客特定**を自動化する。

### 基本構成

- 各店舗の `shop_secrets` に `stores_api_key`／`stores_api_secret` 登録済。
- API連携で取得できる情報：
    - 顧客プロフィール（名前・メール・電話）
    - 予約情報（予約番号・日時・ステータス）

### Webチュートリアル（help.）

1. STORESの「お問い合わせ」リンクから遷移（URLパラメータに`store_code`埋込）。
2. AIチャットで「お名前・電話番号・予約番号」を聞く。
3. APIで顧客照合 → 本人確認 → チケット登録時に顧客特定情報紐付け。

### LINEチュートリアル（line.）

1. LINEログイン（LIFF＋LINEログインチャンネル）でLINEユーザーID取得。
2. STORES会員情報と照合 → 一度紐づけたら永続保持。
3. 顧客発話から予約照会 → AI回答時に予約状況を参照可能。

### 利用DB

- `shop_secrets`（キー管理）
- `customer_links`（LINE ID／STORES顧客IDのマッピング）

---

## 6. リモートロックAPI連携（入室確認）

### 目的

STORES予約情報とリモートロック解錠PINを突き合わせ、**本人確認→PIN提示**をAIチュートリアルで行う。

### 処理フロー

1. リモートロック側アプリから既に発行済みゲスト情報を取得（API）。
2. STORES予約APIで同一顧客・同一予約を照合。
3. 本人一致 → **解錠PIN**をAIチャット（Web／LINE）に表示。
4. 不一致 → チケット化＋本部へエスカレーション。

### APIキー管理

- `shop_secrets` に `remotelock_account_email`／`remotelock_api_key` カラム追加。

---

## 7. 緊急電話代行オペレーター報告メール解析

### 目的

オペレーターからの報告メール本文を自動解析し、

AIが「報告」／「要対応」を分類。**要対応のみチケット化＋SMS＋ChatWork通知。**

### 処理概要

1. 加盟店メールボックス（IMAP）をCronで定期チェック。
2. メール本文→AIコアに解析依頼→分類JSON：
    
    ```json
    { "type": "要対応", "summary": "暗証番号が合わず入室できない" }
    
    ```
    
3. 要対応の場合：
    - チケット化（`source='operator_mail'`）
    - ChatWork通知＋SMS追撃送信（高優先度）

### テーブル

- `operator_mail_logs`（メールID／本文／分類結果／処理結果）

---

## 8. 加盟店↔本部座組（AI相談／MTG予約）

### a. AI相談（本部AIチャット）

- 加盟店→AI一次回答→未解決→本部エスカレーション。
- スレッド管理（`hq_chat_threads`／`hq_chat_messages`）。
- チケット化リンク可能。
- 本部画面からAIコア再利用可能。

### b. MTG予約

- 本部側：`/ai/meetings_admin.php` で空き枠設定。
- 加盟店側：`/shop/meetings.php` で予約。
- 予約確定→メール＋ChatWork通知→前日／1h前リマインド。

---

## 9. データベース構成（主要＋追加）

- `hq_chat_threads`／`hq_chat_messages`／`hq_chat_links`
- `hq_meeting_slots`／`hq_meetings`
- `audit_logs`（操作履歴）
- `tutorial_feedbacks`（AI回答評価）
- `operator_mail_logs`
- `customer_links`（LINE ID↔STORES会員）

---

## 10. 通知・通信

| 区分 | 経路 | 備考 |
| --- | --- | --- |
| ChatWork | API通知（ROOM固定） | エスカレーション・請求・アラート・MTG確定 |
| メール | PHP `mail()` | SPF／DKIM／DMARC認証済 |
| SMS追撃 | Twilio | チケット未返信／オペレーター要対応案件 |
| OpenAI API | HTTPS | AI分類・回答生成 |
| STORES API | HTTPS | 顧客照合／予約確認 |
| RemoteLock API | HTTPS | 解錠PIN取得 |
| LINE | Messaging API + LIFF | 顧客トーク／本人認証 |

---

## 11. 監査・保守・運用

### a. 監査ログ

`audit_logs` で全操作記録（user_id／role／action／entity／timestamp）。

### b. 自動バックアップ

毎日AM3:30にDB＋PDFをバックアップ（7世代保持）。

### c. アラート通知

システム例外を `system@`／ChatWorkに送信（自動レポート）。

### d. スモークテスト

`/shared/tests/smoke.php` でE2E通信確認。

---

## 12. セキュリティ／ポリシー

- SSL／WAF有効化（Xserver標準）。
- SPF／DKIM／DMARC完備。
- .env は公開領域外（権限600）。
- OpenAI通信・API通信はBearer認証＋TLS。
- 顧客情報はマスキングしてAI投入。
- PDF直リンク禁止（download.php経由）。

---

## 13. KPI・可視化・学習

| 項目 | 内容 |
| --- | --- |
| 顧客AIチュートリアル | 自動解決率／追問率／チケット化率 |
| 加盟店ポータル | 売上・体験数・AI対応率グラフ |
| 本部INBOX | 店舗別AI正答率／満足度ランキング |
| 学習フィードバック | `tutorial_feedbacks` 反映でFAQ改良提案をAIが提示 |

---

## 14. FAQ管理・AIチューニングUI（本部）

- CRUD管理：カテゴリ／質問文／回答文／キーワード。
- CSVインポート／エクスポート対応。
- AIコアの温度・スコア閾値設定をUIで調整可能。
- 即時反映（キャッシュ自動更新）。

---

## 15. STORES売上取込・KPI集計

- CSVアップロードまたはAPI取得。
- `sales_records`に登録→`shop_kpis`集計。
- ai.画面で期間別分析・ダッシュボード表示。

---

## 16. cronジョブ一覧

| 名称 | 実行時刻 | 内容 |
| --- | --- | --- |
| `cron_invoices.php` | 毎月1日 03:00 | 請求PDF生成・送信 |
| `cron_sms_followup.php` | 5分間隔 | 未返信チケット追撃 |
| `cron_meeting_reminders.php` | 毎日 | MTG前日／1h前リマインド |
| `cron_operator_mail.php` | 15分間隔 | オペレーター報告メール解析・チケット化 |
| `cron_backup.php` | 毎日 03:30 | DB・PDFバックアップ |

---

## 17. 導入・リリースフロー

| フェーズ | 内容 | 状態 |
| --- | --- | --- |
| 環境構築 | ドメイン／DB／SSL／DNS／メール設定 | 完了 |
| 外部キー取得 | ChatWork／Twilio／LINE／OpenAI／STORES／RemoteLock | 完了 |
| パッケージ展開 | v1.4 Final ZIP配置 | 次工程 |
| 実データ投入 | owners／shops／intents／sales_records | 導入時実施 |
| 検証 | selfcheck／smokeテスト | リリース前 |
| 本番リリース | 2026-01-01 | 予定 |

---

## 18. 今後の拡張

- Google Calendar双方向連携（MTG予約）。
- STORES API完全自動取込。
- RemoteLock制御統合。
- AIコア強化（fine-tuning／embedding学習）。
- マルチブランド展開時のDB分離モード。

---

## ✅ 総括

- 顧客AIチュートリアル（Web／LINE）は体験を分け、AIコアを共有。
- 加盟店↔本部のAIチャット・MTG予約まで一気通貫。
- STORES・RemoteLock・OpenAI・Twilio・ChatWorkを連携。
- 本部UIからAIの**閾値・テンプレ・FAQ**を直接チューニング。
- AIが“人間らしく、かつ正確に”対応し、最終的には**顧客満足・加盟店業務効率・本部運用効率**を同時に最大化。