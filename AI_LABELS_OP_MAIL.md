# AI_LABELS_OP_MAIL.md — OP_MAIL 用ラベル定義・ラベリングガイド

本ファイルは、OP_MAIL（電話代行メール解析）の AI 学習・評価に用いる  
ラベル定義と、ラベリング時の判断基準・典型パターンをまとめたものです。

- 対象テーブル:
  - `operator_mail_logs`（ai_* / final_*）
  - `op_mail_training_samples`（label_*）

---

## 1. ラベル一覧

### 1.1 follow_urgency（フォロー緊急度）

値:

- `high`
- `normal`
- `none`

意味:

- `high`  
  - 加盟店が「早め（原則当日中、場合によっては即）」にフォローすべき案件。
  - 放置するとクレーム・悪い口コミ・解約などに繋がる可能性が高い。

- `normal`  
  - 急ぎではないが、メールやLINEでフォローしておいた方が良い案件。
  - 今日〜数日以内に対応すれば問題ないレベル。

- `none`  
  - 電話オペレーター対応だけで完結しており、追加フォローは不要な案件。
  - ログとして残すだけで良い。

---

### 1.2 resolution_status（解決状態）

値:

- `resolved`
- `unresolved`

意味:

- `resolved`  
  - 電話の時点でお客様の問題が解消している状態。
  - 「謝罪の上お帰りいただいた」は **未解決（unresolved）** 扱いに注意。

- `unresolved`  
  - お客様側から見て、何らかの不満・不安・未解決ポイントが残っている状態。  
  - 加盟店からの連絡や補償判断が必要。

---

### 1.3 incident_category（インシデント種別）

値（v1.4 最小セット）:

- `door_lock_issue`  
  - 鍵・暗証番号・入室に関するトラブル。
- `reservation_mismatch`  
  - 予約が入っていない/確認できない、日付・時間の認識違いなど。
- `device_error`  
  - 脱毛機・電源・ブレーカー等の機器トラブル。
- `forgotten_item`  
  - 忘れ物。
- `equipment_usability`  
  - 備品や設備の使いづらさ・配置への指摘。
- `other`  
  - 上記に当てはまらないもの。

※ 1通に複数の要素が含まれる場合は「どこにフォローが必要か」を軸に  
   主たるカテゴリを 1 つ選ぶ。

---

## 2. ラベルの組み合わせルール

### 2.1 基本ルール

1. `resolution_status='resolved'` の場合、  
   - `follow_urgency='none'` となるのが自然（原則セット）。

2. `resolution_status='unresolved'` の場合、  
   - `follow_urgency in ('high','normal')` のいずれか。

3. 「謝罪の上お帰りいただいた」は常に `unresolved` + `high` 扱い。  
   - なぜ来店できなかったかの原因がどちらにあっても、  
     お客様は利用できていないため、フォローと場合によっては補償検討が必要。

4. 「加盟店に電話したが出ず、そのまま終話」と書かれているものは、  
   - `owner_contact_status='no_answer' or 'line_busy'` + `follow_urgency='high'`。

### 2.2 典型パターン

#### パターンA: 鍵の番号勘違い → 正しい番号を案内し解錠確認済み

- 典型文言:
  - 「暗証番号を誤って入力されていたようで、正しい番号をご案内し解錠確認済みです」
  - 「ご案内後、問題なくご入室いただけました」

- ラベル例:
  - `incident_category = 'door_lock_issue'`
  - `resolution_status = 'resolved'`
  - `follow_urgency = 'none'`

#### パターンB: 鍵が発行されておらず、ご利用いただけなかった（予約が確認できない）

- 典型文言:
  - 「鍵が発行されておらず、ご予約が入っていないようでした」
  - 「ご案内できず、お帰りいただきました」
  - 「謝罪の上お帰りいただきました」

- 注意:  
  オペ側では STORES を見られないため、「予約が入っていないようでした」は **確定ではない**。  
  そのため、加盟店側で STORES を確認することが前提。

- ラベル例:
  - `incident_category = 'reservation_mismatch'` （+ 鍵の文脈が強ければ door_lock_issue も候補）
  - `resolution_status = 'unresolved'`
  - `follow_urgency = 'high'`

#### パターンC: 機械トラブル（何度も落ちる）がありつつ、利用は継続できた

- 典型文言:
  - 「施術中に20回ほど電源が落ちる / 準備中に戻るが、ご利用は続けられていました」
  - 「特にクレームではないとのことですが、一応ご報告します」

- ラベル例:
  - `incident_category = 'device_error'`
  - `resolution_status = 'unresolved'`（不便をかけている）
  - `follow_urgency = 'normal'`  
    （すぐではないが、謝罪＋点検案内などのフォローが望ましい）

#### パターンD: 忘れ物 → すぐに再入室して自分で回収

- 典型文言:
  - 「スマートウォッチの忘れ物 → 5分後に再度来店され、ご自身で回収されました」

- ラベル例:
  - `incident_category = 'forgotten_item'`
  - `resolution_status = 'resolved'`
  - `follow_urgency = 'none'`

#### パターンE: 設備・備品の使いづらさの指摘（ストラップ等）

- 典型文言:
  - 「黄色いストラップが非常に使いづらいとのご指摘」
  - 「ご利用は問題なくできていますが、改善してほしいとのこと」

- ラベル例:
  - `incident_category = 'equipment_usability'`
  - `resolution_status = 'unresolved'`（要改善）
  - `follow_urgency = 'normal'`  
    （早急ではないが、お礼＋改善予定の共有をしたい）

---

## 3. ラベリングの優先度・NGパターン

### 3.1 優先度

ラベリング時は以下の順で判断する:

1. お客様が「利用できたかどうか」
2. 「謝罪の上お帰りいただいた」等、明確に利用できていないニュアンスがあるか
3. オペが加盟店に電話し、繋がったかどうか

### 3.2 NG パターン例

- 「予約は入っていませんでした」と **決めつけるようなラベル付け**  
  - STORES 側で実際に予約がないことを確認していない限り、  
    resolution_status / incident_category は「予約不明」ではなく「要確認」の文脈で付ける。

- お客様側の過失（鍵番号の勘違いなど）があっても、  
  「クレームになり得るケース」を `follow_urgency='none'` にしてしまう。  
  - 例: 何度も機械が落ちた / かなり時間を浪費させてしまった などは `normal` 以上でフォロー候補。

---

## 4. owner_contact_status ラベルガイド

### 4.1 値

- `not_called`  
  - メール中に「加盟店にお電話はしていません」「本日は電話のみで対応いたしました」のような記載がある。
- `reached`  
  - 「加盟店にお繋ぎし、対応を引き継ぎました」「オーナー様に確認を取っております」のような記載。
- `no_answer`  
  - 「加盟店にお電話しましたが応答がなく」「留守番電話にメッセージを残しました」等。
- `line_busy`  
  - 「話し中で繋がらず」といった記載。
- `unknown`  
  - 加盟店への電話について一切記載が無い、または文面から判断できない。

### 4.2 ラベリングルール

- `no_answer` / `line_busy` の場合:
  - `follow_urgency` は **最低でも `high`** に設定する（フォロー必須）。
- `reached` の場合:
  - 引き継ぎ後の状態に応じて `resolution_status` / `follow_urgency` を判断する。

---

## 5. ラベリング運用のおすすめフロー

1. AI が `ai_*` を自動付与。
2. 店舗 / HQ のオペレーターが SHOP_PORTAL / 本部UIから内容を確認し、  
   `final_*` を必要に応じて上書き。
3. 「AI判定と最終判定が大きく異なるもの」や「典型パターン」を  
   `op_mail_training_samples` に登録していく。
4. 学習時は `label_*` を教師データとして利用し、  
   `ai_*` と比較することで精度評価も行う。

---

## 6. ラベリング時のメモ欄の使い方（任意）

- 「なぜこのラベルにしたか」が後で分かるように、  
  本部UI上でメモ欄を用意し、特にグレーなケースには理由を簡単に残す。
  - 例:
    - 「お客様は特に怒っていなかったが、機器トラブルが連続したため normal フォローにした」
    - 「予約が本当に無かったことを STORES で確認済み → high + 補償検討」

これにより、将来ラベル定義を変えたくなった際にも、  
過去ラベリングの意図を再解釈しやすくなる。
